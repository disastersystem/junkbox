<!doctype html>
<html lang="en">
	<head>
		<title>title goes here</title>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">

		<link rel="stylesheet" type="text/css" href="css/css.css">
	</head>
	<body>
		<div id="app" class="container">
			<svg id="board" width="560" height="560" preserveAspectRatio="xMidYMin"></svg>
		</div>

		<script src="node_modules/chess.js/chess.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/svg.js/2.5.3/svg.js"></script>
		<script src="svg.draggable.js"></script>
		<script src="functions.js"></script>

		<script>
			var game = new Chess()
			var board = SVG.get('board')

			var squares = []
			var chars = ['a', 'b', 'c', 'd', 'e', 'f', 'g', 'h']
		    var nums = [8, 7, 6, 5, 4, 3, 2, 1]

		    for (var row = 0; row < 8; row++)
		    {
		        for (var column = 0; column < 8; column++)
		        {   
		            /* is it a odd or even square: odd gets a light colour, even gets dark */
		            if (row % 2 == 0)
		                var colour = (column % 2 == 0) ?  '#F0D9B5' : '#B58863'
		            else
		                var colour = (column % 2 == 0) ? '#B58863' : '#F0D9B5'
		            
		            /* draw the square */
		            var square = board.rect(70, 70).move(column * 70, row * 70).attr({
		                fill: colour,
		                id: chars[column] + nums[row]
		            })

		            squares.push(square)
		        }
		    }

		    var pieces = []
		    var pos = fenToObj( game.fen() )
		    for (var key in pos) {
		        if (pos.hasOwnProperty(key)) {
		            var p = SVG.get(key).bbox()

		            var piece = board.image('pieces/' + pos[key] + '.svg', 60, 60)
		                .move(p.cx - 30, p.cy - 30)
		                .attr({ id: pos[key], class: 'piece'})

					piece.draggable().on('dragend', function(event) {
						
						var thePiece = this
						
						squares.forEach(function(square) {
							
							var pieceCenterX = Math.floor(event.detail.p.x)
							var pieceCenterY = Math.floor(event.detail.p.y)

							var leftPoint   = square.bbox().x
							var rightPoint  = square.bbox().x + square.bbox().width
							
							var topPoint 	= square.bbox().y
							var bottomPoint	= square.bbox().y + square.bbox().height

							var legal = false

							// if the coords is inside the current square this loop is at
							if ( ( (pieceCenterX > leftPoint) &&  (pieceCenterX < rightPoint) ) && ( (pieceCenterY > topPoint) &&  (pieceCenterY < bottomPoint) ) )
							{
								game.moves().forEach(function(move) {
									var pieceCode = thePiece.node.id.slice(-1)
									var squareCode = square.node.id
									var userMove = (pieceCode == 'P') ? squareCode : (pieceCode + squareCode)
									
									if ( userMove == move ) {
										legal = true
										console.log(userMove)
										console.log(move)

										game.move(move)

										thePiece.move(square.bbox().cx - 30, square.bbox().cy - 30)

										// if capture delete pieces
										// if (move.split(-1) == 'c')
									}
								})
								
								// if it is not a legal move send the piece back to its original square
								if (legal == false) {
									thePiece.move(
										event.detail.handler.startPoints.box.x,
										event.detail.handler.startPoints.box.y
									)
								}
								
							}
						})

					})

					pieces.push(piece)
		        }
		    }








		    // identifiser personlige trekk: hjelper ikke tegne, må gjøre det "visuelt" i hodet







			
			// array of coords?

			// dragend event fired
			// 	convert move and square to legal move
			// 	check board.squares() against game.moves()
			// 		if match
			// 			move piece to new sqaure
			// 		else
			// 			reset piece back to square
			// 			event.detail.handler.startPoints.box.x
		</script>
	</body>
</html>